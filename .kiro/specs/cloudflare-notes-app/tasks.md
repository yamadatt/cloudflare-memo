# 実装計画: cloudflare-notes-app

## 概要

Next.js App Router、Cloudflare Workers、D1データベースを使用したメモ帳アプリケーションの実装。段階的にデータベース層、Server Actions、UIコンポーネント、ページを構築し、各段階でテストを実施します。

## タスク

- [ ] 1. プロジェクトのセットアップとデータベース初期化
  - Next.jsプロジェクトの作成（App Router使用）
  - TailwindCSSのセットアップ
  - Cloudflare Workers用の設定（wrangler.toml）
  - D1データベースの作成とスキーマ定義（notesテーブル）
  - TypeScript型定義ファイルの作成（Note, CreateNoteInput, UpdateNoteInput）
  - _要件: 7.1, 7.2, 7.3, 8.1_

- [ ] 2. データベース層の実装
  - [ ] 2.1 D1クライアントラッパーの実装
    - getDatabase()関数の実装
    - D1Databaseインスタンスの取得と型定義
    - _要件: 6.1_

  - [ ] 2.2 CRUD操作関数の実装
    - getAllNotes(): すべてのノートを作成日時降順で取得
    - getNoteById(id): IDでノートを取得
    - createNote(input): 新しいノートを作成（UUID生成、タイムスタンプ記録）
    - updateNote(input): ノートを更新（更新タイムスタンプ記録）
    - deleteNote(id): ノートを削除
    - _要件: 1.1, 2.5, 3.1, 4.3, 5.2, 6.2, 6.3, 6.4, 6.5_

  - [ ]* 2.3 プロパティテスト: ノート作成のラウンドトリップ
    - **プロパティ4: ノート作成のラウンドトリップ**
    - **検証: 要件 2.5, 6.5**

  - [ ]* 2.4 プロパティテスト: ノート更新のラウンドトリップ
    - **プロパティ5: ノート更新のラウンドトリップ**
    - **検証: 要件 4.3, 6.5**

  - [ ]* 2.5 プロパティテスト: ノート削除の完全性
    - **プロパティ6: ノート削除の完全性**
    - **検証: 要件 5.2**

  - [ ]* 2.6 プロパティテスト: ID一意性
    - **プロパティ7: ID一意性**
    - **検証: 要件 6.2**

  - [ ]* 2.7 プロパティテスト: タイムスタンプの記録
    - **プロパティ8: タイムスタンプの記録**
    - **検証: 要件 6.3**

  - [ ]* 2.8 プロパティテスト: 更新タイムスタンプの変更
    - **プロパティ9: 更新タイムスタンプの変更**
    - **検証: 要件 6.4**

  - [ ]* 2.9 ユニットテスト: エッジケース
    - 存在しないIDでの取得（nullを返す）
    - 空のノートリストの取得
    - _要件: 3.7_

- [ ] 3. チェックポイント - データベース層のテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認してください。

- [ ] 4. バリデーション層の実装
  - [ ] 4.1 入力バリデーション関数の実装
    - validateNoteInput(title, content): タイトルと本文のバリデーション
    - タイトルが空白のみの場合はエラー
    - ValidationResult型の定義
    - _要件: 2.4, 4.5_

  - [ ]* 4.2 プロパティテスト: タイトルバリデーション
    - **プロパティ3: タイトルバリデーション**
    - **検証: 要件 2.4, 4.5**

  - [ ]* 4.3 ユニットテスト: バリデーション
    - 有効なタイトルと本文でバリデーション成功
    - 空文字列のタイトルでバリデーション失敗
    - 空白のみのタイトルでバリデーション失敗
    - _要件: 2.4, 4.5_

- [ ] 5. Server Actionsの実装
  - [ ] 5.1 ノート作成アクションの実装
    - createNoteAction(formData): フォームデータからノートを作成
    - バリデーション実行
    - 成功時はリダイレクト、失敗時はエラーを返す
    - ActionResult型の定義
    - _要件: 2.5, 2.6, 2.7_

  - [ ] 5.2 ノート更新アクションの実装
    - updateNoteAction(formData): フォームデータからノートを更新
    - バリデーション実行
    - 成功時はリダイレクト、失敗時はエラーを返す
    - _要件: 4.3, 4.4, 4.6_

  - [ ] 5.3 ノート削除アクションの実装
    - deleteNoteAction(id): ノートを削除
    - 成功時はリダイレクト、失敗時はエラーを返す
    - _要件: 5.2, 5.3, 5.4_

  - [ ]* 5.4 プロパティテスト: エラー時のフォームデータ保持
    - **プロパティ11: エラー時のフォームデータ保持**
    - **検証: 要件 2.7, 4.6**

  - [ ]* 5.5 ユニットテスト: Server Actions
    - 有効な入力でノート作成成功
    - 無効な入力でノート作成失敗
    - データベースエラー時のエラーハンドリング
    - _要件: 2.7, 4.6, 5.4, 9.1_

- [ ] 6. UIコンポーネントの実装
  - [ ] 6.1 NoteCardコンポーネントの実装
    - タイトルと作成日時を表示
    - クリックで詳細ページに遷移
    - TailwindCSSでスタイリング
    - _要件: 1.2, 1.4, 8.1, 8.2_

  - [ ] 6.2 NoteFormコンポーネントの実装
    - タイトル入力フィールド（必須）
    - 本文入力フィールド（textarea）
    - 送信ボタンとキャンセルボタン
    - エラーメッセージ表示領域
    - TailwindCSSでスタイリング
    - _要件: 2.2, 2.3, 8.1, 8.2, 8.4_

  - [ ] 6.3 DeleteButtonコンポーネントの実装
    - クライアントコンポーネントとして実装
    - 削除確認ダイアログの表示
    - deleteNoteActionの呼び出し
    - TailwindCSSでスタイリング
    - _要件: 5.1, 5.5, 8.1, 8.4_

  - [ ]* 6.4 ユニットテスト: UIコンポーネント
    - NoteCardが正しくレンダリングされる
    - NoteFormが必須フィールドを含む
    - DeleteButtonが確認ダイアログを表示
    - _要件: 1.2, 2.2, 2.3, 5.1_

- [ ] 7. ページコンポーネントの実装
  - [ ] 7.1 ノート一覧ページの実装 (app/page.tsx)
    - サーバーコンポーネントとして実装
    - getAllNotes()を呼び出し
    - NoteCardコンポーネントを使用してノートを表示
    - 空のリストの場合は「ノートがありません」メッセージ
    - 新規作成ボタンを配置
    - TailwindCSSでレイアウト
    - _要件: 1.1, 1.2, 1.3, 1.5, 8.1, 8.2, 8.5_

  - [ ]* 7.2 プロパティテスト: ノート一覧の完全性
    - **プロパティ1: ノート一覧の完全性**
    - **検証: 要件 1.1, 1.2**

  - [ ]* 7.3 ユニットテスト: 一覧ページ
    - 空のリストで「ノートがありません」メッセージを表示
    - 新規作成リンクが含まれる
    - _要件: 1.3, 1.5_

- [ ] 8. ノート詳細ページの実装 (app/notes/[id]/page.tsx)
  - [ ] 8.1 詳細ページコンポーネントの実装
    - サーバーコンポーネントとして実装
    - getNoteById(id)を呼び出し
    - 存在しない場合はnotFound()を呼び出し
    - タイトル、本文、作成日時、更新日時を表示
    - 編集ボタンと削除ボタンを配置
    - TailwindCSSでレイアウト
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 8.1, 8.2, 8.5_

  - [ ]* 8.2 プロパティテスト: ノート詳細の完全性
    - **プロパティ2: ノート詳細の完全性**
    - **検証: 要件 3.1, 3.2, 3.3, 3.4**

  - [ ]* 8.3 ユニットテスト: 詳細ページ
    - 存在しないIDで404エラー
    - 編集ボタンと削除ボタンが含まれる
    - _要件: 3.5, 3.6, 3.7_

- [ ] 9. ノート作成ページの実装 (app/notes/new/page.tsx)
  - [ ] 9.1 作成ページコンポーネントの実装
    - サーバーコンポーネントとして実装
    - NoteFormコンポーネントを使用
    - createNoteActionを使用してフォーム送信
    - バリデーションエラーを表示
    - TailwindCSSでレイアウト
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.6, 2.7, 8.1, 8.2, 8.5_

  - [ ]* 9.2 ユニットテスト: 作成ページ
    - フォームが正しく表示される
    - バリデーションエラーが表示される
    - _要件: 2.1, 2.4_

- [ ] 10. ノート編集ページの実装 (app/notes/[id]/edit/page.tsx)
  - [ ] 10.1 編集ページコンポーネントの実装
    - サーバーコンポーネントとして実装
    - getNoteById(id)で既存データを取得
    - NoteFormコンポーネントに既存データを渡す
    - updateNoteActionを使用してフォーム送信
    - バリデーションエラーを表示
    - TailwindCSSでレイアウト
    - _要件: 4.1, 4.2, 4.4, 4.5, 4.6, 8.1, 8.2, 8.5_

  - [ ]* 10.2 プロパティテスト: 編集フォームの初期値
    - **プロパティ10: 編集フォームの初期値**
    - **検証: 要件 4.2**

  - [ ]* 10.3 ユニットテスト: 編集ページ
    - フォームに既存データが表示される
    - バリデーションエラーが表示される
    - _要件: 4.2, 4.5_

- [ ] 11. チェックポイント - すべてのページとコンポーネントのテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認してください。

- [ ] 12. エラーハンドリングの実装
  - [ ] 12.1 カスタム404ページの実装 (app/not-found.tsx)
    - 「ノートが見つかりませんでした」メッセージ
    - 一覧ページへのリンク
    - TailwindCSSでスタイリング
    - _要件: 3.7, 8.1_

  - [ ] 12.2 エラーバウンダリの実装 (app/error.tsx)
    - 予期しないエラーのキャッチ
    - ユーザーフレンドリーなエラーメッセージ
    - リトライボタン
    - エラーログの記録
    - TailwindCSSでスタイリング
    - _要件: 9.1, 9.3, 9.4, 8.1_

  - [ ]* 12.3 プロパティテスト: データベースエラーハンドリング
    - **プロパティ12: データベースエラーハンドリング**
    - **検証: 要件 9.1, 9.3**

  - [ ]* 12.4 プロパティテスト: バリデーションエラーメッセージ
    - **プロパティ13: バリデーションエラーメッセージ**
    - **検証: 要件 9.2**

  - [ ]* 12.5 ユニットテスト: エラーハンドリング
    - データベースエラー時のエラーメッセージ表示
    - ネットワークエラー時のエラーメッセージ表示
    - _要件: 9.1, 9.4_

- [ ] 13. 最終統合とスタイリングの調整
  - [ ] 13.1 レスポンシブデザインの確認と調整
    - モバイルとデスクトップでの表示確認
    - TailwindCSSのブレークポイント調整
    - _要件: 8.2_

  - [ ] 13.2 一貫したスタイリングの適用
    - カラースキームの統一
    - タイポグラフィの統一
    - ボタンとリンクのホバー・フォーカス状態
    - 適切な余白とレイアウト
    - _要件: 8.3, 8.4, 8.5_

  - [ ] 13.3 アクセシビリティの確認
    - キーボードナビゲーション
    - ARIAラベル
    - フォーカス表示
    - _要件: 8.4_

- [ ] 14. 最終チェックポイント
  - すべてのテストが通ることを確認し、質問があればユーザーに確認してください。

## 注意事項

- `*`マークの付いたタスクはオプションで、より速いMVPのためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行います
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
